<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設定 - Home Seismometer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    <header class="text-gray-600 body-font bg-white shadow-md">
        <div class="container mx-auto flex flex-wrap p-5 flex-col md:flex-row items-center">
            <a href="/monitor" class="flex title-font font-medium items-center text-gray-900 mb-4 md:mb-0">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-10 h-10 text-white p-2 bg-indigo-500 rounded-full" viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                <span class="ml-3 text-xl">Home Seismometer</span>
            </a>
            <nav class="md:ml-auto flex flex-wrap items-center text-base justify-center">
                <a href="/monitor" class="mr-5 hover:text-gray-900">モニター</a>
                <a href="/setting" class="mr-5 text-indigo-600 font-semibold border-b-2 border-indigo-600">設定</a>
            </nav>
        </div>
    </header>

    <main class="pt-4 md:p-4">
        <div id="settings-root" class="mx-auto md:mt-8"></div>
    </main>

    <script type="text/babel">
        const DeviceInfoItem = ({ label, value }) => (
            <div className="flex justify-between items-center p-4 bg-gray-50 rounded-md">
                <span className="font-semibold text-gray-700">{label}</span>
                <span className="text-gray-900">{value}</span>
            </div>
        );

        const DeviceInfo = () => {
            const [deviceInfo, setDeviceInfo] = React.useState({
                device_name: '',
                firmware_version: '',
                sensor_name: '',
                ap_ssid: '',
                ap_rssi: '',
                ap_authmode: '',
                ip_address: '',
            });
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                const fetchDeviceInfo = async () => {
                    try {
                        const response = await fetch('/api/device_info');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        setDeviceInfo(data);
                        setError(null);
                    } catch (err) {
                        console.error('Error fetchDeviceInfo:', err);
                        setError('デバイス情報の取得に失敗しました。');
                        setDeviceInfo({
                            device_name: '',
                            firmware_version: '',
                            sensor_name: '',
                            ap_ssid: '',
                            ap_rssi: '',
                            ap_authmode: '',
                            ip_address: '',
                        });
                    }
                };
                fetchDeviceInfo();
            }, []);

            return (
                <div className="p-8">
                    <h1 className="text-2xl font-bold text-gray-800 mb-6 text-center">デバイス情報</h1>
                    {error && <p className="text-red-500 text-center mb-4">{error}</p>}
                    <div className="space-y-4">
                        <DeviceInfoItem label="デバイス名" value={deviceInfo.device_name} />
                        <DeviceInfoItem label="ファームウェア" value={deviceInfo.firmware_version} />
                        <DeviceInfoItem label="加速度センサー" value={deviceInfo.sensor_name} />
                        <DeviceInfoItem label="アクセスポイント" value={deviceInfo.ap_ssid} />
                        <DeviceInfoItem label="RSSI" value={deviceInfo.ap_rssi} />
                        <DeviceInfoItem label="認証タイプ" value={deviceInfo.ap_authmode} />
                        <DeviceInfoItem label="IPアドレス" value={deviceInfo.ip_address} />
                    </div>
                </div>
            );
        };

        const TEMPLATE_VARIABLES = [
            { key: 'is_test', label: 'テスト区分', example: '【テスト】' },
            { key: 'type', label: '通知区分（新規検知/震度更新）', example: '新規検知' },
            { key: 'shindo_class', label: '震度階級', example: '5弱' },
            { key: 'shindo', label: '計測震度', example: '4.7' },
            { key: 'date', label: '検知日付', example: '2026-02-23' },
            { key: 'time', label: '検知時刻', example: '14:05:32' },
            { key: 'report_num', label: '通知カウント', example: '1' },
        ];

        const getPreviewText = (template) => {
            let preview = template;
            TEMPLATE_VARIABLES.forEach(v => {
                const regex = new RegExp(`\\{\\{${v.key}\\}\\}`, 'g');
                preview = preview.replace(regex, v.example);
            });
            return preview;
        };

        const WebhookEditModal = ({ webhook, onClose, onSave, onTestSend, sendingStatus, savingStatus }) => {
            const [name, setName] = React.useState(webhook.name);
            const [url, setUrl] = React.useState(webhook.url);
            const [enabled, setEnabled] = React.useState(webhook.enabled);
            const [threshold, setThreshold] = React.useState(webhook.shindoThreshold);
            const [template, setTemplate] = React.useState(webhook.payload_template);
            const textareaRef = React.useRef(null);

            const handleSave = () => {
                onSave({
                    ...webhook,
                    name,
                    url,
                    enabled,
                    shindoThreshold: threshold,
                    payload_template: template,
                });
            };

            const insertVariable = (varKey) => {
                const ta = textareaRef.current;
                if (!ta) return;
                ta.focus();
                const insert = `{{${varKey}}}`;
                const start = ta.selectionStart;
                const end = ta.selectionEnd;
                const newVal = template.substring(0, start) + insert + template.substring(end);
                setTemplate(newVal);
                requestAnimationFrame(() => {
                    ta.selectionStart = ta.selectionEnd = start + insert.length;
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-lg font-bold text-gray-800">編集 [Store {webhook.id+1} ]</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                        </div>
                        <div className="p-4 space-y-4">
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                                <span className="font-medium text-gray-700">有効</span>
                                <label className="flex items-center cursor-pointer">
                                    <div className="relative">
                                        <input type="checkbox" className="sr-only" checked={enabled} onChange={e => setEnabled(e.target.checked)} />
                                        <div className={`block w-10 h-6 rounded-full ${enabled ? 'bg-indigo-600' : 'bg-gray-300'}`}></div>
                                        <div className={`dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition ${enabled ? 'translate-x-full' : ''}`}></div>
                                    </div>
                                </label>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">名前</label>
                                <input type="text" value={name} onChange={e => setName(e.target.value)}
                                       className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                                <input type="text" value={url} onChange={e => setUrl(e.target.value)}
                                       className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">送信しきい値</label>
                                <input type="number" step="0.1" value={(threshold / 10).toFixed(1)}
                                       onChange={e => setThreshold(Math.round(parseFloat(e.target.value) * 10))}
                                       className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">テンプレート</label>
                                <textarea
                                    ref={textareaRef}
                                    value={template}
                                    onChange={e => setTemplate(e.target.value)}
                                    rows={3}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-500 mb-2">使用可能な変数（タップで挿入）</label>
                                <div className="flex flex-wrap gap-2">
                                    {TEMPLATE_VARIABLES.map(v => (
                                        <button key={v.key} onClick={() => insertVariable(v.key)}
                                                className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 active:bg-indigo-200 transition-colors">
                                            {'{{'}{v.key}{'}}'}
                                            <span className="text-xs text-gray-400">{v.label}  例: {v.example}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-500 mb-1">送信イメージ</label>
                                <div className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-md font-mono text-sm text-gray-700 whitespace-pre-wrap break-all">
                                    {getPreviewText(template)}
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-3 p-4 border-t">
                            <div className="flex-1 flex flex-col">
                                <button
                                    onClick={() => onTestSend({ url, payload_template: template })}
                                    disabled={sendingStatus === 'sending'}
                                    className={`w-full px-4 py-2 rounded-md text-white font-semibold transition-colors
                                        ${sendingStatus === 'sending' ? 'bg-gray-400 cursor-not-allowed' :
                                        'bg-indigo-600 hover:bg-indigo-700'}`}
                                >
                                    {sendingStatus === 'sending' ? '送信中' :
                                     'テスト送信'}
                                </button>
                                <p className={`text-sm h-6 mt-1 text-center ${sendingStatus === 'success' ? 'text-green-600' : sendingStatus === 'error' ? 'text-red-600' : 'text-transparent'}`}>
                                    {sendingStatus === 'success' ? '送信成功' : sendingStatus === 'error' ? '送信失敗' : ' '}
                                </p>
                            </div>
                            <div className="flex-1 flex flex-col">
                                <button
                                    onClick={handleSave}
                                    disabled={savingStatus === 'saving'}
                                    className={`w-full px-4 py-2 rounded-md text-white font-semibold transition-colors
                                        ${savingStatus === 'saving' ? 'bg-gray-400 cursor-not-allowed' :
                                        'bg-green-600 hover:bg-green-700'}`}
                                >
                                    {savingStatus === 'saving' ? '保存中' : '保存'}
                                </button>
                                <p className={`text-sm h-6 mt-1 text-center ${savingStatus === 'success' ? 'text-green-600' : savingStatus === 'error' ? 'text-red-600' : 'text-transparent'}`}>
                                    {savingStatus === 'success' ? '保存完了' : savingStatus === 'error' ? '保存失敗' : ' '}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const WebhookSettings = () => {
            const [webhooks, setWebhooks] = React.useState([]);
            const [sendingStatus, setSendingStatus] = React.useState({});
            const [savingStatus, setSavingStatus] = React.useState('idle');
            const [error, setError] = React.useState(null);
            const [editingWebhook, setEditingWebhook] = React.useState(null);

            const formatWebhooks = (data) => {
                return data.map((wh, index) => {
                    let displayUrl = wh.url;
                    try {
                        const url = new URL(wh.url);
                        displayUrl = url.hostname;
                    } catch (e) {
                        console.error("Invalid URL:", wh.url, e);
                    }
                    return {
                        id: index,
                        enabled: wh.enabled,
                        shindoThreshold: wh.shindo_threshold,
                        name: wh.name,
                        description: `${displayUrl}`,
                        url: wh.url,
                        payload_template: wh.payload_template
                    };
                });
            };

            const fetchWebhooks = async () => {
                try {
                    setError(null);
                    const response = await fetch('/api/webhook/list');
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                    const data = await response.json();
                    const formatted = formatWebhooks(data);
                    setWebhooks(formatted);
                    return formatted;
                } catch (err) {
                    console.error('Error fetching webhooks:', err);
                    setError(`Webhook設定の取得に失敗: ${err.message}`);
                    setWebhooks([]);
                    return [];
                }
            };

            React.useEffect(() => {
                fetchWebhooks();
            }, []);

            const handleSaveWebhook = async (updatedWebhook) => {
                setSavingStatus('saving');
                try {
                    const updatedList = webhooks.map(wh =>
                        wh.id === updatedWebhook.id ? updatedWebhook : wh
                    );

                    const payload = updatedList.map(wh => ({
                        enabled: wh.enabled,
                        shindo_threshold: wh.shindoThreshold,
                        name: wh.name,
                        url: wh.url,
                        payload_template: wh.payload_template,
                    }));

                    const response = await fetch('/api/webhook/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'エラー' }));
                        throw new Error(errorData.message || `HTTP ${response.status}`);
                    }

                    setSavingStatus('success');
                    const latest = await fetchWebhooks();
                    const latestWebhook = latest.find(wh => wh.id === updatedWebhook.id);
                    if (latestWebhook) {
                        setEditingWebhook(latestWebhook);
                    }
                } catch (err) {
                    console.error('Error saving webhook:', err);
                    setSavingStatus('error');
                }
            };

            const handleSendWebhook = async (webhookData) => {
                const editId = editingWebhook?.id;
                if (editId == null) return;
                setSendingStatus(prev => ({ ...prev, [editId]: 'sending' }));
                try {
                    const response = await fetch('/api/webhook/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: webhookData.url,
                            payload_template: webhookData.payload_template,
                        }),
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'エラー' }));
                        throw new Error(`ESP32 API error! status: ${response.status}, message: ${errorData.message}`);
                    }
                    await response.json();
                    setSendingStatus(prev => ({ ...prev, [editId]: 'success' }));
                } catch (err) {
                    console.error('Error sending webhook:', err);
                    setSendingStatus(prev => ({ ...prev, [editId]: 'error' }));
                }
            };

            return (
                <div className="p-4 md:p-8">
                    <h1 className="text-2xl font-bold text-gray-800 mb-6 text-center">通知設定</h1>
                    {error && <p className="text-red-500 text-center mb-4">{error}</p>}
                    <p className="text-sm text-gray-600 mb-4">Webhook 送信先一覧</p>
                    <div className="space-y-6">
                        {webhooks.map((webhook) => (
                            <div key={webhook.id} className="px-3 py-4 bg-gray-50 rounded-lg shadow">
                                <div className="flex items-center">
                                    <div className="flex flex-col items-center mr-4 flex-shrink-0">
                                        <label htmlFor={`enabled-${webhook.id}`} className="flex items-center cursor-pointer">
                                            <div className="relative">
                                                <input
                                                    type="checkbox"
                                                    id={`enabled-${webhook.id}`}
                                                    className="sr-only"
                                                    checked={webhook.enabled}
                                                    disabled
                                                />
                                                <div className={`block w-10 h-6 rounded-full ${webhook.enabled ? 'bg-indigo-600' : 'bg-gray-300'}`}></div>
                                                <div className={`dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition ${webhook.enabled ? 'translate-x-full' : ''}`}></div>
                                            </div>
                                        </label>
                                        <p className="text-xs text-gray-700 mt-1">
                                            {webhook.enabled ? '設定有効' : '設定無効'}
                                        </p>
                                    </div>
                                    <div className="min-w-0 flex-1">
                                        <p className="text-xs text-gray-700 leading-tight">Store {webhook.id+1}</p>
                                        <h2 className="text-lg font-semibold text-gray-700 leading-snug">{webhook.name}</h2>
                                        <p className="text-sm text-gray-500 truncate">{webhook.description}</p>
                                        <p className="text-xs text-gray-500 mt-1">送信震度 {(webhook.shindoThreshold / 10.0).toFixed(1)} 以上</p>
                                    </div>
                                    <div className="flex items-center ml-4 flex-shrink-0">
                                        <button
                                            onClick={() => setEditingWebhook(webhook)}
                                            className="px-4 py-1.5 rounded-md text-sm text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition-colors"
                                        >
                                            編集
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    {editingWebhook && (
                        <WebhookEditModal
                            webhook={editingWebhook}
                            onClose={() => {
                                setEditingWebhook(null);
                                setSendingStatus(prev => {
                                    const next = { ...prev };
                                    delete next[editingWebhook.id];
                                    return next;
                                });
                                setSavingStatus('idle');
                            }}
                            onSave={handleSaveWebhook}
                            onTestSend={handleSendWebhook}
                            sendingStatus={sendingStatus[editingWebhook.id] || 'idle'}
                            savingStatus={savingStatus}
                        />
                    )}
                </div>
            );
        };

        const TabButton = ({ children, isActive, onClick }) => {
            const activeClasses = "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500";
            const inactiveClasses = "whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300";
            return (
                <a href="#" onClick={onClick} className={isActive ? activeClasses : inactiveClasses} aria-current={isActive ? "page" : undefined}>
                    {children}
                </a>
            );
        };

        const Tabs = ({ activeTab, onTabClick }) => {
            const TABS = [
                { id: 'webhook-settings', label: '通知' },
                { id: 'device-info', label: 'デバイス情報' },
            ];

            return (
                <div className="border-b border-gray-200">
                    <nav className="-mb-px flex space-x-8 pl-4" aria-label="Tabs">
                        {TABS.map(tab => (
                            <TabButton
                                key={tab.id}
                                isActive={activeTab === tab.id}
                                onClick={(e) => { e.preventDefault(); onTabClick(tab.id); }}
                            >
                                {tab.label}
                            </TabButton>
                        ))}
                    </nav>
                </div>
            );
        };

        const SettingsPage = () => {
            const [activeTab, setActiveTab] = React.useState('webhook-settings');

            const handleTabClick = (tabId) => {
                setActiveTab(tabId);
            };

            return (
                <div className="w-full md:max-w-2xl mx-auto bg-white md:rounded-lg md:shadow-xl">
                    <Tabs activeTab={activeTab} onTabClick={handleTabClick} />
                    {activeTab === 'webhook-settings' && <WebhookSettings />}
                    {activeTab === 'device-info' && <DeviceInfo />}
                </div>
            );
        };

        const domContainer = document.querySelector('#settings-root');
        const root = ReactDOM.createRoot(domContainer);
        root.render(<SettingsPage />);
    </script>
</body>
</html>